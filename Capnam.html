<html lang="de">
<head>
<title> Capnam </title>
<meta charset='utf-8' />
<link rel="icon" type="image/x-icon" href="img/capnam.png">   <!-- favicon -->
</head>

<body onload="game = neuesLevel()">     <!-- Spielfeld erstellen ohne Knopfdruck und in der game Variable für später speichern-->
  <script src='js/Grid.js'></script>
  <script src='js/maze.js'></script>
  <script src='js/fields.js'></script>
  <script src='js/player.js'></script>
  <script src='js/item.js'></script>


  <h1 class="intro">This is Capnam</h1>
  <h2 class="intro2">EAT collect REPEAT</h2>
  <br>
  <input type="text" value="" id="time" readonly >
  <br>

  <input type="text" id="zuege" value= "0 Zuege gemacht" readonly>
    <input type="text" id="leben" value= "" readonly>      <!--lebensanzeiger: Value wird bei player.prototype.init gesetzt -->
      <input type="text" value="Punkte: 00" id="punkte" readonly >


  <br>
  <canvas id='cvs' width='800px' height='800px' style="background-color:#000000 ;border: 2px solid #000000;"></canvas>
  <br>
  <input type="number" id="dimensions" value="10" placeholder="neue größe?(Anzahl Felder)">   <!-- eine 10 für die automatische Levelgenerierung -->
  <button onclick="var eingabe = document.getElementById('dimensions').value; alert(eingabe +' Felder großes neues Spielfeld? Kommt sofort :)'); game = neuesLevel()">Erstellen</button>  <!-- jetzt: game=neuesLevel-->
  <input type="button" value="Test" onclick="game = neuesLevel()">  <!-- jetzt: game = neuesLevel-->
  <img src="img/capnam.png" style="display: none">
  <img src="img/capnam_u.png" style="display: none">
  <img src="img/capnam_o.png" style="display: none">
  <img src="img/capnam_l.png" style="display: none">

  <div id="footer">
       <p class="footer">- Created by Yannick Bauer</p>
  </div>

  <script>
var cvs = document.getElementById('cvs');
let ctx = cvs.getContext("2d");
//    alert ("Hier kurz die Regeln und Steuerung: \nBewegungen mit w,a,s,d auf der Tastatur\nZiel des Spiels: Überleben und viele Punkte machen")             //hier noch die genaueren Voraussetzungen einfügen


var item = new Item( "Coin", ITEM_TYPE_COIN, 'img/coin.png' );
// var itemFeld = getRandomField();     //getRandomField geht nicht
//itemFeld.item = item;


function neuesLevel()
     {
       start_time = new Date().getTime();
       let dim = document.getElementById('dimensions').value;

       var grid = new Grid( cvs, dim );   // später noch eine Begrenzung einbauen
       const maze = createMaze(grid);     //verursachte einen Fehler. Deshalb was anderes Probiert
       var player1 = new Player ( "player1", maze.start_field, 3);   //später ändern: Farbe brauch ich nicht mehr. Dafür aber Leben
//       grid.drawGrid(maze,player1);
      player1.playerImage.onload = ()=>
{
  player1.drawPlayerPosition( grid );
}
      clear(ctx);
      maze.flat().forEach(field => field.drawField(grid) )
      player1.drawPlayerPosition( grid );
//       grid.drawFieldNumbers();
      document.getElementById('punkte').value ="Punkte: 00";
      return { player: player1, grid: grid, maze: maze }    // player und grid zurück geben, sodass man es überall hat (in der variable game)


     }
function clear (ctx)
{
ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
}

//StartZeit und aktuelle Zeit als Variablen
    var start_time = new Date().getTime();
    var current_time = new Date().getTime();

    function displayTime(input_field)
    {

    		current_time = new Date().getTime();


    		let delta_t = parseInt((current_time - start_time) / 1000);
    		let delta_m = parseInt( delta_t / 60);
    		let delta_s = delta_t % 60;

    		delta_m = delta_m < 10 ? ("0"+delta_m) : delta_m;
    		delta_s = delta_s < 10 ? ("0"+delta_s) : delta_s;

    		let zeittext =`Zeit ${delta_m}:${delta_s}`;
    		input_field.value = zeittext
    	}

Punkte = 0;
function score_move ()
{
  Punkte +=5;
  document.getElementById('punkte').value ="Punkte: " + Punkte;
}

function score_less ()
{
  Punkte -=50;
  document.getElementById('punkte').value ="Punkte: " + Punkte;
}


function score_time ()
{
  Punkte +=10;
  document.getElementById('punkte').value ="Punkte: " + Punkte;
}


setInterval (displayTime, 1000, document.getElementById('time'));
setInterval (score_time, 3500);   //Punkte auf Zeit


cvs.onkeydown = keyDown;
document.body.onkeydown = keyDown;



//keybindings
function keyDown( evt )
{
	let defined_keys = ["ArrowUp","ArrowRight", "ArrowDown" ,"ArrowLeft"]

	console.log( evt.key );


// hier habe ich einen bewegungs counter eingefügt (bewegung++) und der wird nur ausgeführt, wenn "move" ausgeführt wird.

	if ( defined_keys.includes( evt.key ) )
   {
		let direction = defined_keys.indexOf( evt.key ) ;
		game.player.move( game.grid, direction );   //konnte bisher nicht auf den player1 zugreifen. daher jetzt game.player1. Danach grid aus der Variable game genommen (game.grid)


// das html input feld mit der id "zuege" soll den Wert von bewegungen bekommen!!  id ansprechen
    document.getElementById('zuege').value = game.player.steps_done + " Zuege gemacht";

// ... und in der Konsole ausgegeben
		console.log(game.player.steps_done, " Zuege gemacht");
		evt.preventDefault();
	}
}



  </script>
  </body>
  </html>
